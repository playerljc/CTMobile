"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_jquery=_interopRequireDefault(require("jquery")),_CtMobile=_interopRequireDefault(require("./CtMobile")),_Constant=_interopRequireDefault(require("./Constant"));function initial(){var a=this;onHashchange=onHashchange.bind(this),window.addEventListener("hashchange",onHashchange,!1),(0,_jquery.default)(window.document).on("pageBeforeChange",function(e,t){a.setParameter(t)})}function onHashchange(){var e=window.location.hash;hashChange.call(this,e)}function hashChange(e,a){var i=this,t="";if(e){var n=(t=-1!==e.indexOf("?")?e.substring(1,e.indexOf("?")):e.substring(1)).lastIndexOf("_");if(-1===n)return!1;var r=t.substring(0,n);if(!window.document.querySelector("[ct-data-role='page'],#"+r))return!1;i.ctmobile.fireEvent(window.document,"pageBeforeChange",[_CtMobile.default.getUrlParam(e)])}else{if(i.ctmobile.fireEvent(window.document,"pageBeforeChange",[_CtMobile.default.getUrlParam(e)]),i.ctmobile.getFirstPage().getPageId()!==i.ctmobile.getFirstPageId())return void i.ctmobile.createPage(i.ctmobile.getId(i.ctmobile.getFirstPageId())).then(function(e){e.start(_Constant.default._SLIDEDURATION,function(){i.removeFirstPage()})});t=i.ctmobile.getFirstPage().getId()}if(i.getPageById(t)){if(t===i.getLastPage().getId())return!1;for(var o=i.ctmobile.indexOfById(t),s=i.getHistoryLength()-1;o<s;s--)s===o+1?i.getPageByIndex(s).finish(_Constant.default._SLIDEDURATION):i.getPageByIndex(s).finish(0)}else i.ctmobile.createPage(t).then(function(e){e.start(_Constant.default._SLIDEDURATION,function(){if(a&&a.reload&&1<i.getHistoryLength()){var e=i.getHistoryLength()-2,t=i.getPageByIndex(e);t&&t.finish(0,null,a)}})})}function indexOfHistoryByPageId(e){-1!==e.indexOf("?")&&(e=e.substring(0,e.indexOf("?")));for(var t=-1,a=0,i=this.getHistoryLength();a<i;a++)if(this.getPageByIndex(a).getPageId()===e){t=a;break}return t}var Router=function(){function t(e){(0,_classCallCheck2.default)(this,t),Object.assign(this,{ctmobile:e,parameter:null,history:[]}),initial.call(this)}return(0,_createClass2.default)(t,[{key:"startPage",value:function(e,i){var n=this,r="",o="";if(0!==e.indexOf("#")){var t=_CtMobile.default.getUrlParam(e);r=t.pageId,delete t.pageId;var a=[];for(var s in t)t.hasOwnProperty(s)&&a.push(s+"="+t[s]);o=a.join("&")?"?"+a.join("&"):"",r in n.ctmobile.templateDB?l():_jquery.default.ajax({dataType:"text",url:e,success:function(e){n.ctmobile.templateDB[r]=_CtMobile.default.getPageTemplateStrByAjaxStr(e),n.ctmobile.preload((0,_jquery.default)(n.ctmobile.templateDB[r])),l()},error:function(e,t,a){}})}else e=e.substring(1),r=-1!==e.indexOf("?")?(o=e.substring(e.indexOf("?")),e.substring(0,e.indexOf("?"))):e,l();function l(){var e,t=n.ctmobile.getTemplateConfig(r,"ct-data-mode");if(-1!==t.toLowerCase().indexOf("single")){var a=indexOfHistoryByPageId.call(n,r);-1===a?(e=-1!==t.indexOf("singleInstance")&&n.ctmobile.getSingleInstance(r)?n.ctmobile.getSingleInstance(r).getId():n.ctmobile.getId(r+o),i&&i.reload?(window.history.replaceState(null,"","#"+e),hashChange.call(n,"#"+e,i)):window.location.hash="#"+e):n.ctmobile.getPageByIndex(a)!==n.getLastPage()?n.go(-(n.getHistoryLength()-1-a)):n.ctmobile.fireEvent(n.getLastPage().getPageDOM(),"pageShow")}else"standard"!==t&&"result"!==t||(e=n.ctmobile.getId(r+o),i&&i.reload?(window.history.replaceState(null,"","#"+e),hashChange.call(n,"#"+e,i)):window.location.hash="#"+e)}}},{key:"go",value:function(e){window.history.go(e)}},{key:"back",value:function(){this.go(-1)}},{key:"setParameter",value:function(e){this.parameter=e}},{key:"getParameter",value:function(){var e=Object.assign({},this.parameter);return e.pageId&&delete e.pageId,e}},{key:"getPageById",value:function(e){return this.history[this.ctmobile.indexOfById(e)]}},{key:"getPageByIndex",value:function(e){return this.history[e]}},{key:"getLastPage",value:function(){return this.history[this.history.length-1]}},{key:"getHistoryLength",value:function(){return this.history.length}},{key:"addPage",value:function(e){this.history.push(e)}},{key:"removeFirstPage",value:function(){this.history.shift()}},{key:"removeLastPage",value:function(){this.history.pop()}},{key:"removePageByIndex",value:function(e){this.history.splice(e,1)}}]),t}(),_default=Router;exports.default=_default;