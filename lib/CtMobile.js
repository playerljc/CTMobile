"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_typeof2=require("babel-runtime/helpers/typeof"),_typeof3=_interopRequireDefault(_typeof2),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_jquery=require("jquery"),_jquery2=_interopRequireDefault(_jquery),_Page=require("./Page"),_Page2=_interopRequireDefault(_Page),_Router=require("./Router"),_Router2=_interopRequireDefault(_Router),_BorasdCast=require("./BorasdCast"),_BorasdCast2=_interopRequireDefault(_BorasdCast);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function getTemplateDOMById(e){return-1!==e.indexOf("?")&&(e=e.substring(0,e.indexOf("?"))),(0,_jquery2.default)(this.templateDB[e])[0]}function _getTemplateConfig(e,t){var n=getTemplateDOMById.call(this,e).getAttribute(t);return"ct-data-mode"!==t||n||(n="standard"),n}function readyPromise(){return new _promise2.default(function(e){(0,_jquery2.default)(window.document).ready(function(){e()})})}function DOMContentLoadedPromise(){return new _promise2.default(function(e){window.addEventListener("DOMContentLoaded",function(){e()})})}function devicereadyPromise(){return new _promise2.default(function(e){window.document.addEventListener("deviceready",function(){e()})})}function _fireEvent(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[];(0,_jquery2.default)(e).trigger(t,n)}function AjaxPreloadPromise(t){var s=this,l=this;return new _promise2.default(function(e,o){var u=[];console.time("预加载Ajax用时"),(0,_jquery2.default)(t).find("a[ct-data-preload=true][ct-pageId]").each(function(e,t){var n=t.getAttribute("ct-data-ajax"),a=t.getAttribute("ct-pageId");if(!a&&n&&"false"===n)return!1;var r=l.config.router[a],i=r&&r.url?r.url:"";if(!i)return!1;u.push(_jquery2.default.ajax({dataType:"text",url:i,success:function(e){s.templateDB[a]=CtMobileFactory.getPageTemplateStrByAjaxStr(e)},error:function(e,t,n){o(e)}}))}),0!==u.length?_promise2.default.all(u).then(function(){console.timeEnd("预加载Ajax用时"),e()}).catch(function(){o()}):e()})}function initialLocalTemplatePromise(){var a=this,r=this;return new _promise2.default(function(e,t){console.time("初始化本地模板用时:");var n=[];(0,_jquery2.default)(a.bodyDOM).find("div[ct-data-role='page']").each(function(){r.templateDB[this.getAttribute("id")]=this.outerHTML,n.push(AjaxPreloadPromise.call(r,this)),this.parentNode.removeChild(this)}),_promise2.default.all(n).then(function(){console.timeEnd("初始化本地模板用时:"),e()}).catch(function(e){t(e)})})}function _preload(a){var r=this;return new _promise2.default(function(e,t){var n=[];n.push(AjaxPreloadPromise.call(r,a)),_promise2.default.all(n).then(function(){e()}).catch(function(e){t(e)})})}function LinkCapturePromise(){var u=this;return new _promise2.default(function(e){console.time("捕获a标签用时:"),window.document.addEventListener("click",function(e){e.preventDefault();var t=e.target;if(t&&("a"===t.tagName.toLocaleLowerCase()||(t=CtMobileFactory.getParentElementByTag(t,"a")))){var n=t.getAttribute("ct-data-ajax");if(!n||"false"!==n){var a=t.getAttribute("ct-pageId");console.log(a);var r=t.getAttribute("ct-parameter")||"";if(a){var i=u.config.router[a],o=(i&&i.url?i.url:"#"+a)+"?pageId="+a+r;return u.startPage(o,{reload:"true"===t.getAttribute("ct-reload")||u.config.linkCaptureReload}),!1}}}}),console.timeEnd("捕获a标签用时:"),e()})}function newInstance(e){var t=e.Class,n=e.id,a=e.pageId,r=(void 0===t?"undefined":(0,_typeof3.default)(t)).toLowerCase(),i=_getTemplateConfig.call(this,a,"ct-data-mode"),o=void 0;if("function"===r?o=t:"undefined"===r&&(o=_Page2.default),!o)throw"页面管理类无法初始化";return-1!==i.toLowerCase().indexOf("singleinstance")?(this.getSingleInstance(a)||(this.singleInstances[a]=new o(this,n)),this.singleInstances[a]):new o(this,n)}function _createPage(i){var o=this;return new _promise2.default(function(t,n){var a=i.substring(0,i.lastIndexOf("_")),r=void 0;if(o.config.router[a]){var e=o.config.router[a].component;e&&e.then?e.then(function(e){e&&(r=e.default)?t(newInstance.call(o,{Class:r,id:i,pageId:a})):n()}).catch(function(e){n(e)}):t(newInstance.call(o,{Page:_Page2.default,id:i,pageId:a}))}else t(newInstance.call(o,{Page:_Page2.default,id:i,pageId:a}))})}function onReady(){var e=this,r=this;this.hasInited||(this.hasInited=!0,this.bodyDOM=window.document.body,this.singleInstances=null,this.maskDOM=(0,_jquery2.default)("<div class='ct-page-mask'> <div opt='animation' class='la-ball-circus la-dark' style='color:#3e98f0;'>   <div></div>   <div></div>   <div></div>   <div></div>   <div></div> </div></div>")[0],this.bodyDOM.appendChild(this.maskDOM),_promise2.default.all([initialLocalTemplatePromise.call(this),LinkCapturePromise.call(this)]).then(function(){console.timeEnd("总用时"),_fireEvent(window.document,"pageBeforeChange",[CtMobileFactory.getUrlParam(window.location.hash)]),_createPage.call(e,e.getFirstId()).then(function(e){e.start(0,function(){if(!window.location.hash)return!1;var e=r.getPageIdByHash();if(!e)return!1;var t=r.config.router[e];if(!t||t.url){var n=t&&t.url?t.url:"#"+e,a=r.getParameterByHash();r.startPage(""+n+a+(a?"&pageId="+e:"?pageId="+e),{reload:r.config.linkCaptureReload})}})})}))}function init(){var e=this.config.supportCordova,t=void 0!==e&&e;onReady=onReady.bind(this),t?_promise2.default.all([readyPromise(),DOMContentLoadedPromise(),devicereadyPromise()]).then(function(){onReady(),_fireEvent(window.document,"DOMContentAndDeviceReady")}).catch(function(e){}):((0,_jquery2.default)(window.document).ready(onReady),window.addEventListener("DOMContentLoaded",onReady))}var CtMobile=function(){function t(e){(0,_classCallCheck3.default)(this,t),this.config=e,this.hasInited=!1,this.templateDB={},this.zIndex=0,this.router=new _Router2.default(this),this.borasdcast=new _BorasdCast2.default,init.call(this)}return(0,_createClass3.default)(t,[{key:"startPage",value:function(e,t){this.router.startPage(e,t)}},{key:"createPage",value:function(e){return _createPage.call(this,e)}},{key:"preload",value:function(e){return _preload.call(this,e)}},{key:"back",value:function(){this.router.go(-1)}},{key:"getFirstId",value:function(){return this.getId(this.getFirstPageId())}},{key:"getId",value:function(e){var t=e.indexOf("?");return-1!==t?e.substring(0,t)+"_"+(new Date).getTime()+e.substring(t):e+"_"+(new Date).getTime()}},{key:"getPageIdByHash",value:function(){var e=window.location.hash;return e?-1!==e.indexOf("?")?(e=e.substring(0,e.lastIndexOf("?"))).substring(1,e.lastIndexOf("_")):e.substring(1,e.lastIndexOf("_")):""}},{key:"getParameterByHash",value:function(){var e=window.location.hash;return e&&-1!==e.indexOf("?")?e.substring(e.lastIndexOf("?")):""}},{key:"getFirstPageId",value:function(){var e=void 0;for(var t in this.templateDB){e=t;break}return e}},{key:"getPageById",value:function(e){return this.router.getPageById(this.indexOfById(e))}},{key:"getSingleInstance",value:function(e){return this.singleInstances||(this.singleInstances={}),this.singleInstances[e]}},{key:"fireEvent",value:function(e,t,n){_fireEvent(e,t,n)}},{key:"getTemplateConfig",value:function(e,t){return _getTemplateConfig.call(this,e,t)}},{key:"getPageByIndex",value:function(e){return this.router.getPageByIndex(e)}},{key:"indexOfById",value:function(e){for(var t=-1,n=0,a=this.getHistoryLength();n<a;n++)if(this.getPageByIndex(n).getId()===e){t=n;break}return t}},{key:"getFirstPage",value:function(){return this.router.getPageByIndex(0)}},{key:"getLastPage",value:function(){return this.router.getLastPage()}},{key:"getParameter",value:function(){return this.router.getParameter()}},{key:"getHistoryLength",value:function(){return this.router.getHistoryLength()}},{key:"getRequest",value:function(e){if(0===this.getHistoryLength()||1===this.getHistoryLength())return{};var t=this.indexOfById(e.getId());return t<=0||t>this.getHistoryLength()-1?{}:this.getPageByIndex(this.getHistoryLength()-2).requestIntent||{}}},{key:"registerReceiver",value:function(e,t){this.borasdcast.registerReceiver(e,t)}},{key:"executeReceiverById",value:function(e,t){this.borasdcast.executeReceiverById(e,t)}},{key:"unregisterReceiver",value:function(e,t){this.borasdcast.unregisterReceiver(e,t)}},{key:"unregisterReceiverByDom",value:function(e){this.borasdcast.unregisterReceiverByDom(e)}},{key:"sendBroadcast",value:function(e){this.borasdcast.sendBroadcast(e)}},{key:"sendOrderedBroadcast",value:function(e){this.borasdcast.sendOrderedBroadcast(e)}}]),t}(),CtMobileFactory={getUrlParam:function(e){var t=/([^&=]+)=([\w\W]*?)(&|$)/g,n=/^[^\?]+\?([\w\W]+)$/.exec(e),a={};if(n&&n[1])for(var r=n[1],i=void 0;null!=(i=t.exec(r));)a[i[1]]=decodeURI(i[2]);return a},getParentElementByTag:function(e,n){if(!n)return null;var a=null,r=e;return function e(){if(!(r=r.parentElement))return null;var t=r.tagName.toLocaleLowerCase();t===n?a=r:"body"===t?a=null:e()}(),a},getPageTemplateStrByAjaxStr:function(e){var t=void 0;if(e=e.trim(),new RegExp("(<[^>]+\\bct-data-role=[\"']?page[\"']?[^>]*>)").test(e)){var n=e.split(/<\/?body[^>]*>/gim);t=(0,_jquery2.default)((0===(n||[]).length?"":1<n.length?n[1]:n[0])||"")[0]}return t?t.outerHTML:""},create:function(e){return new CtMobile(e)}};exports.default=CtMobileFactory;