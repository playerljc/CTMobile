"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),_jquery=_interopRequireDefault(require("jquery")),_Page=_interopRequireDefault(require("./Page")),_Router=_interopRequireDefault(require("./Router")),_BorasdCast=_interopRequireDefault(require("./BorasdCast"));function getTemplateDOMById(e){return-1!==e.indexOf("?")&&(e=e.substring(0,e.indexOf("?"))),(0,_jquery.default)(this.templateDB[e])[0]}function _getTemplateConfig(e,t){var n=getTemplateDOMById.call(this,e).getAttribute(t);return"ct-data-mode"!==t||n||(n="standard"),n}function readyPromise(){return new Promise(function(e){(0,_jquery.default)(window.document).ready(function(){e()})})}function DOMContentLoadedPromise(){return new Promise(function(e){window.addEventListener("DOMContentLoaded",function(){e()})})}function devicereadyPromise(){return new Promise(function(e){window.document.addEventListener("deviceready",function(){e()})})}function _fireEvent(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[];(0,_jquery.default)(e).trigger(t,n)}function AjaxPreloadPromise(t){var s=this,c=this;return new Promise(function(e,o){var u=[];console.time("预加载Ajax用时"),(0,_jquery.default)(t).find("a[ct-data-preload=true][ct-pageId]").each(function(e,t){var n=t.getAttribute("ct-data-ajax"),a=t.getAttribute("ct-pageId");if(!a&&n&&"false"===n)return!1;var r=c.config.router[a],i=r&&r.url?r.url:"";if(!i)return!1;u.push(_jquery.default.ajax({dataType:"text",url:i,success:function(e){s.templateDB[a]=CtMobileFactory.getPageTemplateStrByAjaxStr(e)},error:function(e,t,n){o(e)}}))}),0!==u.length?Promise.all(u).then(function(){console.timeEnd("预加载Ajax用时"),e()}).catch(function(){o()}):e()})}function initialLocalTemplatePromise(){var a=this,r=this;return new Promise(function(e,t){console.time("初始化本地模板用时:");var n=[];(0,_jquery.default)(a.bodyDOM).find("div[ct-data-role='page']").each(function(){r.templateDB[this.getAttribute("id")]=this.outerHTML,n.push(AjaxPreloadPromise.call(r,this)),this.parentNode.removeChild(this)}),Promise.all(n).then(function(){console.timeEnd("初始化本地模板用时:"),e()}).catch(function(e){t(e)})})}function _preload(a){var r=this;return new Promise(function(e,t){var n=[];n.push(AjaxPreloadPromise.call(r,a)),Promise.all(n).then(function(){e()}).catch(function(e){t(e)})})}function LinkCapturePromise(){var u=this;return new Promise(function(e){console.time("捕获a标签用时:"),window.document.addEventListener("click",function(e){e.preventDefault();var t=e.target;if(t&&("a"===t.tagName.toLocaleLowerCase()||(t=CtMobileFactory.getParentElementByTag(t,"a")))){var n=t.getAttribute("ct-data-ajax");if(!n||"false"!==n){var a=t.getAttribute("ct-pageId"),r=t.getAttribute("ct-parameter")||"";if(a){var i=u.config.router[a],o="".concat(i&&i.url?i.url:"#"+a,"?pageId=").concat(a).concat(r);return u.startPage(o,{reload:"true"===t.getAttribute("ct-reload")||u.config.linkCaptureReload}),!1}}}}),console.timeEnd("捕获a标签用时:"),e()})}function newInstance(e){var t,n=e.Class,a=e.id,r=e.pageId,i=(0,_typeof2.default)(n).toLowerCase(),o=_getTemplateConfig.call(this,r,"ct-data-mode");if("function"===i?t=n:"undefined"===i&&(t=_Page.default),!t)throw"页面管理类无法初始化";return-1!==o.toLowerCase().indexOf("singleinstance")?(this.getSingleInstance(r)||(this.singleInstances[r]=new t(this,a)),this.singleInstances[r]):new t(this,a)}function _createPage(i){var o=this;return new Promise(function(t,n){var a,r=i.substring(0,i.lastIndexOf("_"));if(o.config.router[r]){var e=o.config.router[r].component;e&&e.then?e.then(function(e){e&&(a=e.default)?t(newInstance.call(o,{Class:a,id:i,pageId:r})):n()}).catch(function(e){n(e)}):t(newInstance.call(o,{Page:_Page.default,id:i,pageId:r}))}else t(newInstance.call(o,{Page:_Page.default,id:i,pageId:r}))})}function onReady(){var e=this,i=this;this.hasInited||(this.hasInited=!0,this.bodyDOM=window.document.body,this.singleInstances=null,this.maskDOM=(0,_jquery.default)("<div class='ct-page-mask'> <div opt='animation' class='la-ball-circus la-dark' style='color:#3e98f0;'>   <div></div>   <div></div>   <div></div>   <div></div>   <div></div> </div></div>")[0],this.bodyDOM.appendChild(this.maskDOM),Promise.all([initialLocalTemplatePromise.call(this),LinkCapturePromise.call(this)]).then(function(){console.timeEnd("总用时"),_fireEvent(window.document,"pageBeforeChange",[CtMobileFactory.getUrlParam(window.location.hash)]),_createPage.call(e,e.getFirstId()).then(function(e){e.start(0,function(){if(!window.location.hash)return!1;var e=i.getPageIdByHash();if(!e)return!1;var t=i.config.router[e];if(!t||t.url){var n=t&&t.url?t.url:"#".concat(e),a=i.getParameterByHash(),r=CtMobileFactory.getUrlParam("".concat(n).concat(a));i.startPage("".concat(n).concat(a).concat(a?r.pageId?"":"&pageId=".concat(e):"?pageId=".concat(e)),{reload:i.config.linkCaptureReload})}})})}))}function init(){var e=this.config.supportCordova,t=void 0!==e&&e;onReady=onReady.bind(this),t?Promise.all([readyPromise(),DOMContentLoadedPromise(),devicereadyPromise()]).then(function(){onReady(),_fireEvent(window.document,"DOMContentAndDeviceReady")}).catch(function(e){}):((0,_jquery.default)(window.document).ready(onReady),window.addEventListener("DOMContentLoaded",onReady))}var CtMobile=function(){function t(e){(0,_classCallCheck2.default)(this,t),this.config=e,this.hasInited=!1,this.templateDB={},this.zIndex=0,this.router=new _Router.default(this),this.borasdcast=new _BorasdCast.default,init.call(this)}return(0,_createClass2.default)(t,[{key:"startPage",value:function(e,t){this.router.startPage(e,t)}},{key:"createPage",value:function(e){return _createPage.call(this,e)}},{key:"preload",value:function(e){return _preload.call(this,e)}},{key:"back",value:function(){this.router.go(-1)}},{key:"getFirstId",value:function(){return this.getId(this.getFirstPageId())}},{key:"getId",value:function(e){var t=e.indexOf("?");return-1!==t?e.substring(0,t)+"_"+(new Date).getTime()+e.substring(t):e+"_"+(new Date).getTime()}},{key:"getPageIdByHash",value:function(){var e=window.location.hash;return e?-1!==e.indexOf("?")?(e=e.substring(0,e.lastIndexOf("?"))).substring(1,e.lastIndexOf("_")):e.substring(1,e.lastIndexOf("_")):""}},{key:"getParameterByHash",value:function(){var e=window.location.hash;return e&&-1!==e.indexOf("?")?e.substring(e.lastIndexOf("?")):""}},{key:"getFirstPageId",value:function(){var e;for(var t in this.templateDB){e=t;break}return e}},{key:"getPageById",value:function(e){return this.router.getPageById(this.indexOfById(e))}},{key:"getSingleInstance",value:function(e){return this.singleInstances||(this.singleInstances={}),this.singleInstances[e]}},{key:"fireEvent",value:function(e,t,n){_fireEvent(e,t,n)}},{key:"getTemplateConfig",value:function(e,t){return _getTemplateConfig.call(this,e,t)}},{key:"getPageByIndex",value:function(e){return this.router.getPageByIndex(e)}},{key:"indexOfById",value:function(e){for(var t=-1,n=0,a=this.getHistoryLength();n<a;n++)if(this.getPageByIndex(n).getId()===e){t=n;break}return t}},{key:"getFirstPage",value:function(){return this.router.getPageByIndex(0)}},{key:"getLastPage",value:function(){return this.router.getLastPage()}},{key:"getParameter",value:function(){return this.router.getParameter()}},{key:"getHistoryLength",value:function(){return this.router.getHistoryLength()}},{key:"getRequest",value:function(e){if(0===this.getHistoryLength()||1===this.getHistoryLength())return{};var t=this.indexOfById(e.getId());return t<=0||t>this.getHistoryLength()-1?{}:this.getPageByIndex(this.getHistoryLength()-2).requestIntent||{}}},{key:"registerReceiver",value:function(e,t){this.borasdcast.registerReceiver(e,t)}},{key:"executeReceiverById",value:function(e,t){this.borasdcast.executeReceiverById(e,t)}},{key:"unregisterReceiver",value:function(e,t){this.borasdcast.unregisterReceiver(e,t)}},{key:"unregisterReceiverByDom",value:function(e){this.borasdcast.unregisterReceiverByDom(e)}},{key:"sendBroadcast",value:function(e){this.borasdcast.sendBroadcast(e)}},{key:"sendOrderedBroadcast",value:function(e){this.borasdcast.sendOrderedBroadcast(e)}}]),t}(),CtMobileFactory={getUrlParam:function(e){var t=/([^&=]+)=([\w\W]*?)(&|$)/g,n=/^[^\?]+\?([\w\W]+)$/.exec(e),a={};if(n&&n[1])for(var r,i=n[1];null!=(r=t.exec(i));)a[r[1]]=decodeURI(r[2]);return a},getParentElementByTag:function(e,n){if(!n)return null;var a=null,r=e;return function e(){if(!(r=r.parentElement))return null;var t=r.tagName.toLocaleLowerCase();t===n?a=r:"body"===t?a=null:e()}(),a},getPageTemplateStrByAjaxStr:function(e){var t;if(e=e.trim(),new RegExp("(<[^>]+\\bct-data-role=[\"']?page[\"']?[^>]*>)").test(e)){var n=e.split(/<\/?body[^>]*>/gim);t=(0,_jquery.default)((0===(n||[]).length?"":1<n.length?n[1]:n[0])||"")[0]}return t?t.outerHTML:""},create:function(e){return new CtMobile(e)}},_default=CtMobileFactory;exports.default=_default;